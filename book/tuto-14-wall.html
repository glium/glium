<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Normal mapping | Introduction</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="./perf-intro.html" />
    
    
    <link rel="prev" href="./tuto-13-phong.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="1.14"
        data-chapter-title="Normal mapping"
        data-filepath="tuto-14-wall.md"
        data-basepath="."
        data-revision="Tue Jan 16 2018 16:47:08 GMT-0800 (PST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> Tutorial</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="tuto-01-getting-started.html">
            
                
                    <a href="./tuto-01-getting-started.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Opening a window
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="tuto-02-triangle.html">
            
                
                    <a href="./tuto-02-triangle.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Drawing a triangle
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="tuto-03-animated-triangle.html">
            
                
                    <a href="./tuto-03-animated-triangle.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Uniforms
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="tuto-04-matrices.html">
            
                
                    <a href="./tuto-04-matrices.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Matrices
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="tuto-05-colors.html">
            
                
                    <a href="./tuto-05-colors.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Adding colors
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="tuto-06-texture.html">
            
                
                    <a href="./tuto-06-texture.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                        Adding a texture
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="tuto-07-shape.html">
            
                
                    <a href="./tuto-07-shape.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                        A more complex shape
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="tuto-08-gouraud.html">
            
                
                    <a href="./tuto-08-gouraud.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                        Gouraud shading
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="tuto-09-depth.html">
            
                
                    <a href="./tuto-09-depth.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                        Depth testing
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="tuto-10-perspective.html">
            
                
                    <a href="./tuto-10-perspective.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.</b>
                        
                        Adjusting the perspective
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="tuto-11-backface-culling.html">
            
                
                    <a href="./tuto-11-backface-culling.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.11.</b>
                        
                        Backface culling
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="tuto-12-camera.html">
            
                
                    <a href="./tuto-12-camera.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.12.</b>
                        
                        The camera and summary of the vertex processing stages
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="tuto-13-phong.html">
            
                
                    <a href="./tuto-13-phong.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.13.</b>
                        
                        Blinn-phong shading
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="1.14" data-path="tuto-14-wall.html">
            
                
                    <a href="./tuto-14-wall.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.14.</b>
                        
                        Normal mapping
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.15" >
            
            <span><b>1.15.</b> Parallax mapping</span>
            
            
        </li>
    
        <li class="chapter " data-level="1.16" >
            
            <span><b>1.16.</b> Deferred shading</span>
            
            
        </li>
    
        <li class="chapter " data-level="1.17" >
            
            <span><b>1.17.</b> Shadow mapping</span>
            
            
        </li>
    
        <li class="chapter " data-level="1.18" >
            
            <span><b>1.18.</b> Antialiasing</span>
            
            
        </li>
    
        <li class="chapter " data-level="1.19" >
            
            <span><b>1.19.</b> Drawing lots of objects with instancing</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="perf-intro.html">
            
                
                    <a href="./perf-intro.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Performances
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="perf-sync.html">
            
                
                    <a href="./perf-sync.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Synchronization
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >Introduction</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="a-textured-wall">A textured wall</h1>
<p>For this next section, we are going to discard the teapot and draw a wall instead.</p>
<h2 id="the-wall">The wall</h2>
<p>Since this is a pretty simple shape, we can build it ourselves:</p>
<pre><code class="lang-rust"><span class="hljs-preprocessor">#[derive(Copy, Clone)]</span>
<span class="hljs-keyword">struct</span> Vertex {
    position: [<span class="hljs-keyword">f32</span>; <span class="hljs-number">3</span>],
    normal: [<span class="hljs-keyword">f32</span>; <span class="hljs-number">3</span>],
}

implement_vertex!(Vertex, position, normal);

<span class="hljs-keyword">let</span> shape = glium::vertex::VertexBuffer::new(&amp;display, &amp;[
        Vertex { position: [-<span class="hljs-number">1.0</span>,  <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>], normal: [<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, -<span class="hljs-number">1.0</span>] },
        Vertex { position: [ <span class="hljs-number">1.0</span>,  <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>], normal: [<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, -<span class="hljs-number">1.0</span>] },
        Vertex { position: [-<span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>], normal: [<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, -<span class="hljs-number">1.0</span>] },
        Vertex { position: [ <span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>], normal: [<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, -<span class="hljs-number">1.0</span>] },
    ]).unwrap();
</code></pre>
<p>We only have four vertices. The reason is that we are going to use a triangle strip. With
a triangle strip, the GPU will draw one triangle with vertices 0, 1 and 2, and another
triangle with vertices 1, 2, and 3. A triangle strip is very useful when drawing rectangles
or rectangular shapes.</p>
<pre><code class="lang-rust">target.draw(&amp;shape, glium::index::NoIndices(glium::index::PrimitiveType::TriangleStrip), &amp;program,
            &amp;uniform! { model: model, view: view, perspective: perspective, u_light: light },
            &amp;params).unwrap();
</code></pre>
<p>The rest of the code is mostly the same as before. You should know by now how to draw something!</p>
<p><img src="tuto-14-step1.png" alt="What it looks like after step 1"></p>
<h2 id="applying-a-texture">Applying a texture</h2>
<p>To apply a texture, we do exactly the same thing as a few sections earlier:</p>
<ul>
<li>We load the texture at initialization.</li>
<li>We add a <code>tex_coords</code> attribute to the vertices.</li>
<li>We pass the texture as a uniform.</li>
<li>We get the ambient and diffuse colors from the texture.</li>
</ul>
<p>Loading the texture is done like we have already done before:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> image = image::load(Cursor::new(&amp;include_bytes!(<span class="hljs-string">&quot;../book/tuto-14-diffuse.jpg&quot;</span>)[..]),
                        image::JPEG).unwrap().to_rgba();
<span class="hljs-keyword">let</span> image_dimensions = image.dimensions();
<span class="hljs-keyword">let</span> image = glium::texture::RawImage2d::from_raw_rgba_reversed(&amp;image.into_raw(), image_dimensions);
<span class="hljs-keyword">let</span> diffuse_texture = glium::texture::SrgbTexture2d::new(&amp;display, image).unwrap();
</code></pre>
<p>Adding the texture coordinates is also very easy:</p>
<pre><code class="lang-rust"><span class="hljs-preprocessor">#[derive(Copy, Clone)]</span>
<span class="hljs-keyword">struct</span> Vertex {
    position: [<span class="hljs-keyword">f32</span>; <span class="hljs-number">3</span>],
    normal: [<span class="hljs-keyword">f32</span>; <span class="hljs-number">3</span>],
    tex_coords: [<span class="hljs-keyword">f32</span>; <span class="hljs-number">2</span>],
}

implement_vertex!(Vertex, position, normal, tex_coords);
</code></pre>
<p>Passing the texture involves adding a new uniform in our fragment shader:</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">uniform</span> <span class="hljs-keyword">sampler2D</span> diffuse_tex;
</code></pre>
<p>And passing it when drawing:</p>
<pre><code class="lang-rust">target.draw(&amp;shape, glium::index::NoIndices(glium::index::PrimitiveType::TriangleStrip), &amp;program,
            &amp;uniform! { model: model, view: view, perspective: perspective,
                        u_light: light, diffuse_tex: &amp;diffuse_texture },
            &amp;params).unwrap();
</code></pre>
<p>And then in the fragment shader, we load the diffuse and ambient colors from the texture instead.</p>
<p>We just replace this:</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">const</span> <span class="hljs-keyword">vec3</span> ambient_color = <span class="hljs-keyword">vec3</span>(<span class="hljs-number">0.2</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>);
<span class="hljs-keyword">const</span> <span class="hljs-keyword">vec3</span> diffuse_color = <span class="hljs-keyword">vec3</span>(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>);
</code></pre>
<p>With this:</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">vec3</span> diffuse_color = <span class="hljs-built_in">texture</span>(diffuse_tex, v_tex_coords).rgb;
<span class="hljs-keyword">vec3</span> ambient_color = diffuse_color * <span class="hljs-number">0.1</span>;
</code></pre>
<p>And we should get a textured wall!</p>
<p><img src="tuto-14-step2.png" alt="The textured wall"></p>
<h2 id="normal-mapping">Normal mapping</h2>
<p>However the outcome is not great. You can clearly see that it&apos;s just a rectangle with a wall
drawn on it and not an actual wall.</p>
<p>There is a technique that can greatly improve the quality of the rendering: normal mapping.</p>
<p>The problem with our current rendering is that the light doesn&apos;t penetrate between the rocks.
If each individual stone was drawn one by one the rendering would be much better thanks to
lighting.</p>
<p>Normal mapping consists in adjusting the lighting calculation of our rectangle in order to do
as if there were individual stones in there. This is done by providing a normal <em>per-fragment</em>.
If you remember, a normal is a vector perpendicular to the surface at a location. By using
more fine-grained normals, we can also make the user believe that the surface itself is
fine-grained.</p>
<p>Here is what a <em>normal map</em> is:</p>
<p><img src="tuto-14-normal.png" alt="The normal map"></p>
<p>As you can see there are a lot of similarities with the regular texture. Each pixel of the normal
map represents the value of the normal at this pixel&apos;s location. Instead of storing colors we
store arbitrary values that represent the normal. For example normal maps are often blue because
blue is the value <code>(0.0, 0.0, 1.0)</code> which is a vector pointing to the outside.</p>
<p>Let&apos;s start with the beginning. We load the normal map into a texture:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> image = image::load(Cursor::new(&amp;include_bytes!(<span class="hljs-string">&quot;../book/tuto-14-normal.png&quot;</span>)[..]),
                        image::PNG).unwrap().to_rgba();
<span class="hljs-keyword">let</span> image_dimensions = image.dimensions();
<span class="hljs-keyword">let</span> image = glium::texture::RawImage2d::from_raw_rgba_reversed(&amp;image.into_raw(), image_dimensions);
<span class="hljs-keyword">let</span> normal_map = glium::texture::Texture2d::new(&amp;display, image).unwrap();
</code></pre>
<p>And we add a new uniform in our fragment shader:</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">uniform</span> <span class="hljs-keyword">sampler2D</span> normal_tex;
</code></pre>
<p>Now instead of using the value of <code>v_normal</code> that comes from our vertex shader, we are going to
load the normal from the normal map, similarly to how we load the diffuse color from the diffuse
texture.</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">vec3</span> normal_map = <span class="hljs-built_in">texture</span>(normal_tex, v_tex_coords).rgb;
</code></pre>
<p>However there is a problem. The value stored in the normal map contains the normal vectors
relative to the surface of the object. But during our calculations we are in scene coordinates
relative to the camera. We need to multiply the value we load from the normal map by a matrix
in order to get usable values. This matrix is called the <strong>TBN</strong> matrix (for
<em>Tangent Binormal Normal</em>).</p>
<p>In the past, some of the calculations required for this matrix were precomputed and passed
as attributes. But calculating this on the fly is really practical. Here is a function from
<a href="http://www.thetenthplanet.de/archives/1180" target="_blank">http://www.thetenthplanet.de/archives/1180</a> that
calculates it:</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">mat3</span> cotangent_frame(<span class="hljs-keyword">vec3</span> normal, <span class="hljs-keyword">vec3</span> pos, <span class="hljs-keyword">vec2</span> uv) {
    <span class="hljs-keyword">vec3</span> dp1 = <span class="hljs-built_in">dFdx</span>(pos);
    <span class="hljs-keyword">vec3</span> dp2 = <span class="hljs-built_in">dFdy</span>(pos);
    <span class="hljs-keyword">vec2</span> duv1 = <span class="hljs-built_in">dFdx</span>(uv);
    <span class="hljs-keyword">vec2</span> duv2 = <span class="hljs-built_in">dFdy</span>(uv);

    <span class="hljs-keyword">vec3</span> dp2perp = <span class="hljs-built_in">cross</span>(dp2, normal);
    <span class="hljs-keyword">vec3</span> dp1perp = <span class="hljs-built_in">cross</span>(normal, dp1);
    <span class="hljs-keyword">vec3</span> T = dp2perp * duv1.x + dp1perp * duv2.x;
    <span class="hljs-keyword">vec3</span> B = dp2perp * duv1.y + dp1perp * duv2.y;

    <span class="hljs-keyword">float</span> invmax = <span class="hljs-built_in">inversesqrt</span>(<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(T, T), <span class="hljs-built_in">dot</span>(B, B)));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">mat3</span>(T * invmax, B * invmax, normal);
}
</code></pre>
<p>Thanks to this we can calculate the <em>real</em> normal, in other words the normal of the surface
at the given pixel:</p>
<pre><code class="lang-glsl"><span class="hljs-keyword">mat3</span> tbn = cotangent_frame(v_normal, v_position, v_tex_coords);
<span class="hljs-keyword">vec3</span> real_normal = <span class="hljs-built_in">normalize</span>(tbn * -(normal_map * <span class="hljs-number">2.0</span> - <span class="hljs-number">1.0</span>));
</code></pre>
<p>The rest of the code is the same as before. We apply phong shading, except that we use
<code>real_normal</code> instead of <code>v_normal</code>.</p>
<p>And here is the result:</p>
<p><img src="tuto-14-step3.png" alt="Final result"></p>
<p>This is much more convincing!</p>
<p><strong><a href="https://github.com/glium/glium/blob/master/examples/tutorial-14.rs" target="_blank">You can find the entire source code here</a>.</strong></p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./tuto-13-phong.html" class="navigation navigation-prev " aria-label="Previous page: Blinn-phong shading"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./perf-intro.html" class="navigation navigation-next " aria-label="Next page: Performances"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"livereload":{}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
