name: ci

on: [push, pull_request]

jobs:
  build:

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
        toolchain: [stable, beta, nightly]

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@master
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        override: true
    - name: Run cargo check --all
      env:
        RUSTFLAGS: -D warnings
      run: |
        cargo check --all --all-targets
    - name: Compile the tests
      env:
        RUSTFLAGS: -D warnings
      run: |
         cargo test --all --all-targets --no-run
    - name: Install Xvfb
      if: (matrix.os == 'ubuntu-latest')
      run: |
        sudo apt-get install libxkbcommon-x11-0
        sudo apt-get install xvfb
    - name: Run the tests (X11)
      if: (matrix.os == 'ubuntu-latest')
      env:
        RUST_BACKTRACE: 1
        RUSTFLAGS: -D warnings
      run: xvfb-run cargo test --all --all-targets
    - name: Set up Mesa
      if: (matrix.os == 'windows-latest')
      run: |
        $url = 'https://github.com/pal1000/mesa-dist-win/releases/download/25.0.3/mesa3d-25.0.3-release-msvc.7z'
        curl.exe -L --output mesa.7z --url $url
        7z e mesa.7z -otarget\debug\deps `
            x64\opengl32.dll `
            x64\libgallium_wgl.dll `
            x64\dxil.dll `
            x64\d3d10warp.dll
    - name: Run the tests (Windows)
      if: (matrix.os == 'windows-latest')
      env:
        RUST_BACKTRACE: 1
        RUSTFLAGS: -D warnings
      run: cargo test --all --all-targets
    - name: Run cargo doc
      env:
        RUSTFLAGS: -D warnings
      run: |
        cargo doc --all --all-features
  book:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Install mdbook
      run: |
        sudo snap install mdbook
    - name: Run mdbook
      run: |
        cd book && mdbook build
        mkdir gh-pages && mv book gh-pages
    - name: Deploy to gh pages
      uses: JamesIves/github-pages-deploy-action@v4.2.3
      with:
        branch: gh-pages
        folder: book/gh-pages
      if: github.event.repository.owner.login == 'glium' && github.event_name == 'push'
